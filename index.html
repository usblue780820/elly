<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 APPLE & ELLY Áè≠Ë°®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ÂºïÂÖ•‰ΩøÁî®ËÄÖ‰∏äÂÇ≥ÁöÑÊâãÂØ´Â≠óÂûã */
        @font-face {
            font-family: 'JasonHandwriting';
            src: url('JasonHandwriting1.ttf') format('truetype');
            font-display: swap;
        }

        :root {
            --primary-color: #38bdf8; /* Sky 400 */
            --bg-color: #f0f9ff; /* Sky 50 */
            --grid-line-color: #cbd5e1; /* Slate 300 - Ê†ºÁ∑öÈ°èËâ≤ */
        }

        body {
            font-family: 'JasonHandwriting', 'ÂæÆËªüÊ≠£ÈªëÈ´î', sans-serif;
            background-color: var(--bg-color);
            color: #334155; /* Slate 700 */
            -webkit-tap-highlight-color: transparent;
            /* ÁÇ∫‰∫ÜÂõ∫ÂÆöÈ†ÇÈÉ®ËàáÂ∫ïÈÉ®ÔºåBody ÈúÄË¶ÅË∂≥Â§†ÁöÑ Padding */
            padding-top: 140px; 
            padding-bottom: 100px;
        }

        /* Ê°åÈù¢ÁâàË™øÊï¥ Padding */
        @media (min-width: 1024px) {
            body {
                padding-top: 2rem;
                padding-bottom: 2rem;
            }
        }

        button, select, input, textarea {
            font-family: 'JasonHandwriting', sans-serif;
            font-size: 1.1rem; 
        }

        /* ËÉåÊôØË£ùÈ£æ */
        .bg-decor-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            overflow: hidden;
        }

        .decor-img {
            position: absolute;
            opacity: 0.05;
            width: 260px;
            max-width: 52vw;
        }

        .decor-top-right { top: 20px; right: -20px; transform: rotate(15deg); }
        .decor-mid-left { top: 50%; left: -30px; transform: translateY(-50%) rotate(-10deg); }
        .decor-btm-right { bottom: 20px; right: -20px; transform: rotate(-15deg); }

        /* ÊúàÊõÜÊ®£Âºè - Âº∑ÂåñÊ†ºÁ∑ö */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px; /* ÈÄôË£°ÁöÑÁ∏´ÈöôÊúÉÈÄèÂá∫ËÉåÊôØËâ≤ÔºåÂΩ¢ÊàêÊ†ºÁ∑ö */
            background-color: var(--grid-line-color); /* Ë®≠ÂÆöÊ†ºÁ∑öÈ°èËâ≤ */
            border: 1px solid var(--grid-line-color); /* Â§ñÊ°Ü */
            border-radius: 0 0 1rem 1rem;
            overflow: hidden;
        }

        .day-cell {
            height: 80px;
            overflow: hidden;
            background-color: white;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            padding: 2px;
            position: relative;
        }

        @media (min-width: 768px) {
            .day-cell { height: 130px; padding: 4px; }
        }

        .day-cell.selected {
            background-color: #e0f2fe !important;
            box-shadow: inset 0 0 0 2px #38bdf8;
        }

        .date-num {
            font-size: 0.7rem; /* ÊîæÂ§ß 10% (Âéü 0.62rem -> 0.7rem) */
            color: #64748b; /* Á®çÂæÆÊ∑±‰∏ÄÈªûÁöÑÁÅ∞ */
            margin-bottom: 1px;
            font-weight: bold;
            padding-left: 2px;
        }
        
        @media (min-width: 768px) {
            .date-num { font-size: 0.85rem; /* ÊîæÂ§ß 10% (Âéü 0.76rem -> 0.85rem) */ }
        }

        .shift-tag {
            font-size: 0.55rem; /* ÊîæÂ§ß 10% (Âéü 0.48rem -> 0.55rem) */
            padding: 1px 3px;
            border-radius: 4px;
            margin-top: 1px;
            display: block;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-weight: bold;
            border-left-width: 2px;
            line-height: 1.2;
        }
        
        @media (min-width: 768px) {
            .shift-tag {
                font-size: 0.7rem; /* ÊîæÂ§ß 10% (Âéü 0.62rem -> 0.7rem) */
                padding: 2px 4px;
            }
        }

        .remark-tag {
            font-size: 0.5rem; /* ÊîæÂ§ß 10% (Âéü 0.43rem -> 0.5rem) */
            padding: 1px 2px;
            margin-bottom: 2px; /* Â¢ûÂä†‰∏ÄÈªû‰∏ãÈÇäË∑ùËàáÁè≠Ë°®ÂçÄÈöî */
            background-color: #fffbeb;
            border: 1px dashed #fcd34d;
            color: #92400e;
            border-radius: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.1;
        }

        /* Èö±ËóèÊç≤Ëª∏‰ΩÜ‰øùÁïôÂäüËÉΩ */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* Loader */
        .loader {
            border: 4px solid #e0f2fe;
            border-top: 4px solid #38bdf8;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .modal { display: none; opacity: 0; transition: opacity 0.3s; }
        .modal.show { display: flex; opacity: 1; }
        
        .shadow-soft { box-shadow: 0 4px 20px -2px rgba(56, 189, 248, 0.25); }
        .shadow-top { box-shadow: 0 -4px 20px -2px rgba(56, 189, 248, 0.15); }
    </style>
</head>
<body>

    <!-- ËÉåÊôØÂ±§ -->
    <div class="bg-decor-container">
        <img src="kiki.jpg" class="decor-img decor-top-right" alt="" onerror="this.style.display='none'">
        <img src="kiki.jpg" class="decor-img decor-mid-left" alt="" onerror="this.style.display='none'">
        <img src="kiki.jpg" class="decor-img decor-btm-right" alt="" onerror="this.style.display='none'">
    </div>

    <!-- È†ÇÈÉ®Âõ∫ÂÆöÂ∞éË¶ΩÂàó -->
    <div class="fixed top-0 left-0 w-full z-40 bg-white/95 backdrop-blur shadow-sm border-b border-sky-100 transition-all duration-300 lg:static lg:bg-transparent lg:shadow-none lg:border-none lg:mb-6">
        <div class="max-w-6xl mx-auto p-3 lg:px-6">
            <div class="flex flex-col lg:flex-row items-center justify-between gap-3">
                <!-- Ê®ôÈ°åËàáÊ®°ÂºèÂàáÊèõ -->
                <div class="flex items-center justify-between w-full lg:w-auto gap-3">
                    <h1 class="text-xl lg:text-3xl text-sky-500 font-bold tracking-wide truncate">2026 APPLE & ELLY</h1>
                    
                    <div class="flex bg-sky-50 p-1 rounded-xl shrink-0">
                        <button id="viewModeBtn" onclick="setMode('view')" class="px-4 py-1.5 rounded-lg text-base transition-all bg-white shadow-sm text-sky-600 font-bold">ÁÄèË¶Ω</button>
                        <button id="editModeBtn" onclick="setMode('edit')" class="px-4 py-1.5 rounded-lg text-base transition-all text-slate-400 hover:text-slate-600">ÊéíÁè≠</button>
                    </div>
                </div>

                <!-- ÊéßÂà∂È†Ö -->
                <div class="flex items-center gap-2 w-full lg:w-auto justify-between overflow-x-auto scrollbar-hide">
                    <!-- ÁÄèË¶ΩÁØ©ÈÅ∏ -->
                    <div id="viewFilterContainer" class="flex-1 min-w-[100px] transition-all duration-300">
                        <select id="viewFilterSelect" onchange="applyViewFilter()" class="w-full bg-sky-50 border border-sky-100 text-sky-600 rounded-lg px-2 py-2 text-base focus:outline-none">
                            <option value="">ÂÖ®ÈÉ®È°ØÁ§∫</option>
                        </select>
                    </div>

                    <!-- Êúà‰ªΩÈÅ∏Êìá -->
                    <div class="flex-1 min-w-[120px]">
                        <select id="yearMonthSelect" onchange="loadMonthData()" class="w-full bg-white border border-slate-200 text-slate-600 rounded-lg px-2 py-2 text-base focus:outline-none">
                            <option value="202601">2026/01</option>
                            <option value="202602">2026/02</option>
                            <option value="202603">2026/03</option>
                            <option value="202604">2026/04</option>
                            <option value="202605">2026/05</option>
                            <option value="202606">2026/06</option>
                            <option value="202607">2026/07</option>
                            <option value="202608">2026/08</option>
                            <option value="202609">2026/09</option>
                            <option value="202610">2026/10</option>
                            <option value="202611">2026/11</option>
                            <option value="202612">2026/12</option>
                        </select>
                    </div>
                    
                    <!-- Â∑•ÂÖ∑ÊåâÈàï -->
                    <div class="flex gap-2 shrink-0">
                        <div id="connectionStatus" class="flex items-center justify-center w-10 h-10 bg-slate-100 rounded-lg text-slate-400">
                            <span class="w-2.5 h-2.5 rounded-full bg-slate-300"></span>
                        </div>
                        <button onclick="clearCacheAndReload()" class="w-10 h-10 flex items-center justify-center text-slate-400 hover:text-sky-500 bg-white border border-slate-200 rounded-lg" title="Âº∑Âà∂ÈáçÊñ∞Êï¥ÁêÜ (Ê∏ÖÈô§Âø´Âèñ)">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ‰∏ªÂÖßÂÆπÂçÄ -->
    <div id="app" class="max-w-6xl mx-auto p-2 lg:p-0 relative z-10">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            
            <!-- ÊâãÊ©üÁâàÔºöÂ∫ïÈÉ®Âõ∫ÂÆöÊéíÁè≠Â∑•ÂÖ∑Âàó / Ê°åÈù¢ÁâàÔºöÂ∑¶ÂÅ¥Âç°Áâá -->
            <div id="editTools" class="fixed bottom-0 left-0 w-full bg-white shadow-top z-50 rounded-t-3xl transform transition-transform duration-300 translate-y-full lg:translate-y-0 lg:static lg:col-span-1 lg:block lg:shadow-soft lg:rounded-3xl lg:border lg:border-sky-100 hidden p-4 pb-8 lg:p-5">
                
                <div class="flex lg:flex-col gap-4 items-center lg:items-stretch">
                    
                    <!-- ‰∫∫Âì°ÈÅ∏Êìá -->
                    <div class="w-1/3 lg:w-full min-w-[120px]">
                        <label class="block text-xs font-bold text-sky-400 mb-1 pl-1 lg:block hidden">1. ÈÅ∏Êìá‰∫∫Âì°</label>
                        <div class="relative">
                            <select id="personSelect" onchange="updateShiftList()" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-2.5 appearance-none focus:ring-2 focus:ring-sky-200 focus:border-sky-400 outline-none text-base font-bold text-slate-700">
                                <option value="">ÈÅ∏‰∫∫...</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-400">
                                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                            </div>
                        </div>
                    </div>

                    <!-- Áè≠Âà•ÈÅ∏Êìá -->
                    <div class="flex-1 lg:w-full overflow-hidden">
                        <label class="block text-xs font-bold text-sky-400 mb-1 pl-1 lg:block hidden">2. ÈÅ∏ÊìáÁè≠Âà•</label>
                        <div id="shiftList" class="flex gap-2 overflow-x-auto scrollbar-hide lg:grid lg:grid-cols-2 lg:gap-2 lg:max-h-64 lg:overflow-y-auto">
                            <p class="text-slate-300 text-sm whitespace-nowrap lg:whitespace-normal py-2 px-2">Ë´ãÂÖàÈÅ∏Êìá‰∫∫Âì°</p>
                        </div>
                    </div>
                </div>

                <!-- Â∫ïÈÉ®Êìç‰ΩúÂçÄ -->
                <div class="mt-3 pt-3 border-t border-sky-50 flex items-center gap-3 lg:block">
                    <div class="hidden lg:flex justify-between items-center mb-2">
                        <span class="text-sm text-slate-400">Â∑≤ÈÅ∏Êó•Êúü</span>
                        <span id="selectedCountDesktop" class="text-xl font-bold text-sky-500">0</span>
                    </div>
                    
                    <!-- Ê∏ÖÈô§ÊåâÈàï -->
                    <button onclick="clearSelection()" class="p-3 bg-slate-100 rounded-xl text-slate-500 hover:bg-slate-200 lg:w-full lg:mt-2 lg:bg-transparent lg:text-slate-400 lg:hover:bg-transparent lg:hover:text-sky-500 lg:py-1">
                        <span class="lg:hidden"><svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></span>
                        <span class="hidden lg:inline text-sm">Ê∏ÖÈô§ÈÅ∏Âèñ</span>
                    </button>

                    <!-- ÂÑ≤Â≠òÊåâÈàï -->
                    <button onclick="applyBatchShifts()" id="saveBtn" disabled class="flex-1 bg-sky-400 text-white py-3 rounded-xl text-lg font-bold hover:bg-sky-500 shadow-lg shadow-sky-200 disabled:bg-slate-200 disabled:text-slate-400 disabled:shadow-none transition-all active:scale-95 flex justify-center items-center gap-2">
                        <span id="saveBtnText">ÂÑ≤Â≠ò</span>
                        <span id="selectedCountMobile" class="bg-white/20 px-2 py-0.5 rounded text-sm lg:hidden">0</span>
                    </button>
                </div>
            </div>

            <!-- ‰∏ªÊó•ÊõÜÂçÄÂüü -->
            <div id="calendarContainer" class="lg:col-span-4 bg-white rounded-2xl lg:rounded-3xl shadow-soft border border-sky-100 overflow-hidden relative">
                <!-- ÊòüÊúüÊ®ôÈ°å (ÈÄôË£°‰πüÂä†‰∏äÊ†ºÁ∑öÈ¢®Ê†º) -->
                <div class="grid grid-cols-7 gap-px bg-slate-300 rounded-t-2xl lg:rounded-t-3xl border-b border-slate-300 relative z-20">
                    <div class="py-2 text-center text-sm lg:text-lg font-bold text-sky-600 bg-white">Êó•</div>
                    <div class="py-2 text-center text-sm lg:text-lg font-bold text-sky-600 bg-white">‰∏Ä</div>
                    <div class="py-2 text-center text-sm lg:text-lg font-bold text-sky-600 bg-white">‰∫å</div>
                    <div class="py-2 text-center text-sm lg:text-lg font-bold text-sky-600 bg-white">‰∏â</div>
                    <div class="py-2 text-center text-sm lg:text-lg font-bold text-sky-600 bg-white">Âõõ</div>
                    <div class="py-2 text-center text-sm lg:text-lg font-bold text-sky-600 bg-white">‰∫î</div>
                    <div class="py-2 text-center text-sm lg:text-lg font-bold text-sky-600 bg-white">ÂÖ≠</div>
                </div>
                
                <div class="relative">
                    <div id="calendarBody" class="calendar-grid relative z-10 bg-slate-300 pb-0">
                        <!-- Content -->
                        <div class="col-span-7 py-20 flex flex-col items-center justify-center text-slate-300 gap-4 bg-white">
                            <div class="loader"></div>
                            <span class="text-xl">ËÆÄÂèñË≥áÊñô‰∏≠...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÂΩàÁ™óÂçÄÂüü -->
        <div id="remarkModal" class="modal fixed inset-0 bg-sky-900/30 backdrop-blur-sm z-[60] items-center justify-center p-4">
            <div class="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-sm transform transition-all scale-100">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold text-slate-700">Á∑®ËºØÂÇôË®ª</h3>
                    <span id="remarkDateTitle" class="bg-sky-100 text-sky-600 px-3 py-1 rounded-full text-sm font-bold"></span>
                </div>
                <div class="mb-6">
                    <textarea id="remarkInput" rows="5" class="w-full bg-amber-50 border-2 border-amber-100 rounded-2xl p-4 text-lg text-slate-700 focus:ring-4 focus:ring-amber-100 focus:border-amber-300 outline-none resize-none placeholder-amber-200" placeholder="ÂØ´Èªû‰ªÄÈ∫º..."></textarea>
                </div>
                <div class="flex gap-3">
                    <button onclick="document.getElementById('remarkModal').classList.remove('show')" class="flex-1 py-3 text-lg text-slate-500 hover:bg-slate-50 rounded-2xl transition-colors">ÂèñÊ∂à</button>
                    <button onclick="saveRemark()" class="flex-1 py-3 text-lg bg-sky-400 text-white rounded-2xl font-bold hover:bg-sky-500 shadow-lg shadow-sky-200 transition-all active:scale-95">ÂÑ≤Â≠ò</button>
                </div>
            </div>
        </div>

        <div id="debugModal" class="modal fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[60] items-center justify-center p-4">
            <div class="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-2xl max-h-[80vh] flex flex-col">
                <h3 class="text-2xl font-bold mb-4 text-slate-700 flex items-center gap-2">
                    Ë≥áÊñôË®∫Êñ∑
                </h3>
                <div class="flex-1 overflow-auto border-2 border-slate-100 rounded-2xl p-4 bg-slate-50 font-mono text-sm text-slate-600">
                    <pre id="debugContent">Ê≠£Âú®ËÆÄÂèñ...</pre>
                </div>
                <div class="pt-4 text-right">
                    <button onclick="document.getElementById('debugModal').classList.remove('show')" class="px-6 py-2 bg-slate-200 text-slate-600 rounded-xl hover:bg-slate-300 font-bold">ÈóúÈñâ</button>
                </div>
            </div>
        </div>

        <div id="toast" class="fixed bottom-32 left-1/2 transform -translate-x-1/2 translate-y-20 opacity-0 transition-all duration-300 bg-slate-800/90 backdrop-blur text-white px-6 py-3 rounded-2xl shadow-2xl flex items-center gap-3 z-[70]">
            <span id="toastMsg" class="font-bold tracking-wide"></span>
        </div>

        <div id="globalLoader" class="fixed inset-0 bg-white/80 backdrop-blur-sm z-[80] flex flex-col items-center justify-center hidden">
            <div class="loader mb-4 w-16 h-16 border-4"></div>
            <p class="text-sky-500 font-bold text-xl animate-pulse">Ë≥áÊñôÂêåÊ≠•‰∏≠...</p>
        </div>
    </div>

    <!-- ÈÇèËºØËÖ≥Êú¨ -->
    <script>
        const DEFAULT_URL = 'https://script.google.com/macros/s/AKfycbzCBZ2i6P68KZ_LjgoVhQjcD2dMLcw1nd5pjMcxX_me-Sl1CWGnrrVYLe-AmMRbnvYY/exec';
        
        // --- Âø´ÂèñÁÆ°ÁêÜ ---
        const Cache = {
            prefix: 'shift_sys_',
            get: function(key) {
                try {
                    const data = localStorage.getItem(this.prefix + key);
                    if (!data) return null;
                    const parsed = JSON.parse(data);
                    // 30ÂàÜÈêòÈÅéÊúü (ÈõñÁÑ∂ÊàëÂÄë‰∏ªË¶Å‰æùË≥¥‰∏ªÂãïÊ∏ÖÈô§Ôºå‰ΩÜÂä†ÂÄãÈÅéÊúüÊôÇÈñì‰øùÈö™)
                    if (Date.now() - parsed.timestamp > 30 * 60 * 1000) {
                        this.remove(key);
                        return null;
                    }
                    return parsed.value;
                } catch (e) { return null; }
            },
            set: function(key, value) {
                try {
                    const item = { value: value, timestamp: Date.now() };
                    localStorage.setItem(this.prefix + key, JSON.stringify(item));
                } catch (e) {}
            },
            remove: function(key) {
                localStorage.removeItem(this.prefix + key);
            },
            clearAll: function() {
                // Ê∏ÖÈô§ÊâÄÊúâÁõ∏ÈóúÂø´Âèñ
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith(this.prefix)) {
                        localStorage.removeItem(key);
                    }
                });
            }
        };

        // --- È°èËâ≤ÂÆöÁæ©ËàáÈÇèËºØ ---
        const shiftColorPalette = [
            { bg: 'bg-orange-50', text: 'text-orange-700', border: 'border-orange-300' },
            { bg: 'bg-emerald-50', text: 'text-emerald-700', border: 'border-emerald-300' },
            { bg: 'bg-blue-50', text: 'text-blue-700', border: 'border-blue-300' },
            { bg: 'bg-amber-50', text: 'text-amber-700', border: 'border-amber-300' },
            { bg: 'bg-purple-50', text: 'text-purple-700', border: 'border-purple-300' },
            { bg: 'bg-lime-50', text: 'text-lime-700', border: 'border-lime-300' },
            { bg: 'bg-indigo-50', text: 'text-indigo-700', border: 'border-indigo-300' },
            { bg: 'bg-cyan-50', text: 'text-cyan-700', border: 'border-cyan-300' },
            { bg: 'bg-fuchsia-50', text: 'text-fuchsia-700', border: 'border-fuchsia-300' },
            { bg: 'bg-teal-50', text: 'text-teal-700', border: 'border-teal-300' },
            { bg: 'bg-yellow-50', text: 'text-yellow-700', border: 'border-yellow-300' },
            { bg: 'bg-violet-50', text: 'text-violet-700', border: 'border-violet-300' },
            { bg: 'bg-sky-50', text: 'text-sky-700', border: 'border-sky-300' },
            { bg: 'bg-slate-50', text: 'text-slate-700', border: 'border-slate-300' },
        ];

        let assignedColors = {}; 
        let colorIndex = 0;      

        function getShiftColor(name) {
            if (!name) return shiftColorPalette[0];
            if (name.includes("‰ºëÂÅá")) {
                return { bg: 'bg-red-50', text: 'text-red-700', border: 'border-red-300' };
            }
            if (assignedColors[name]) {
                return assignedColors[name];
            }
            const style = shiftColorPalette[colorIndex % shiftColorPalette.length];
            assignedColors[name] = style;
            colorIndex++;
            return style;
        }

        let scriptUrl = localStorage.getItem('gas_script_url') || DEFAULT_URL;
        let currentMode = 'view';
        let profileData = {}; 
        let currentSchedule = []; 
        let selectedDates = new Set();
        let selectedShift = null;
        let editingDate = null;
        let currentViewFilter = "";

        window.onload = function() {
            checkConfig();
            const now = new Date();
            const currentYm = now.getFullYear() + String(now.getMonth() + 1).padStart(2, '0');
            const ymSelect = document.getElementById('yearMonthSelect');
            if (ymSelect.querySelector(`option[value="${currentYm}"]`)) {
                ymSelect.value = currentYm;
            }
            if (scriptUrl) initApp();
        };

        function checkConfig() {
            const status = document.getElementById('connectionStatus');
            if (!scriptUrl) {
                status.innerHTML = '<span class="w-3 h-3 rounded-full bg-red-400 shadow-sm"></span>';
                status.title = "Êú™ÈÄ£Á∑ö";
            } else {
                status.innerHTML = '<span class="w-3 h-3 rounded-full bg-green-400 shadow-[0_0_8px_rgba(74,222,128,0.6)]"></span>';
                status.title = "Â∑≤ÈÄ£Á∑ö";
            }
        }

        async function callBackend(action, payload = {}) {
            if (!scriptUrl) return;
            toggleLoader(true);
            const body = JSON.stringify({ action, ...payload });
            try {
                const response = await fetch(scriptUrl, { method: 'POST', mode: 'cors', body: body });
                const text = await response.text();
                let json = JSON.parse(text);
                if (json.status === 'error') throw new Error(json.message);
                return json.data;
            } catch (err) {
                console.error('API Error:', err);
                showToast("ÈÄ£Á∑öÈåØË™§: " + err.message);
                throw err;
            } finally {
                toggleLoader(false);
            }
        }

        async function initApp() {
            try {
                // ÂòóË©¶ÂæûÂø´ÂèñËÆÄÂèñ Profile
                const cachedProfile = Cache.get('profile');
                if (cachedProfile) {
                    profileData = cachedProfile;
                    console.log('Profile loaded from cache');
                } else {
                    profileData = await callBackend('getProfile');
                    Cache.set('profile', profileData);
                }
                
                renderPersonSelect();
                renderViewFilterSelect();
                loadMonthData();
            } catch (err) { console.error("Init failed", err); }
        }

        function renderPersonSelect() {
            const select = document.getElementById('personSelect');
            select.innerHTML = '<option value="">ÈÅ∏‰∫∫...</option>';
            if (profileData && Object.keys(profileData).length > 0) {
                Object.keys(profileData).forEach(name => {
                    const opt = document.createElement('option');
                    opt.value = name;
                    opt.textContent = name;
                    select.appendChild(opt);
                });
            }
        }

        function renderViewFilterSelect() {
            const select = document.getElementById('viewFilterSelect');
            select.innerHTML = '<option value="">ÂÖ®ÈÉ®È°ØÁ§∫</option>';
            if (profileData && Object.keys(profileData).length > 0) {
                Object.keys(profileData).forEach(name => {
                    const opt = document.createElement('option');
                    opt.value = name;
                    opt.textContent = name;
                    select.appendChild(opt);
                });
            }
        }

        function applyViewFilter() {
            currentViewFilter = document.getElementById('viewFilterSelect').value;
            renderCalendar();
        }

        async function loadMonthData() {
            const ym = document.getElementById('yearMonthSelect').value;
            
            // ÂòóË©¶ÂæûÂø´ÂèñËÆÄÂèñ
            const cachedData = Cache.get('month_' + ym);
            if (cachedData) {
                currentSchedule = cachedData;
                console.log(`Month ${ym} loaded from cache`);
                renderCalendar();
                return;
            }

            try {
                const result = await callBackend('getMonthData', { sheetName: ym });
                if (!result.exists) {
                    showToast(`ÁÑ° ${ym} Ë≥áÊñô`);
                    currentSchedule = [];
                } else {
                    currentSchedule = result.values;
                    // ÂØ´ÂÖ•Âø´Âèñ
                    Cache.set('month_' + ym, currentSchedule);
                }
                renderCalendar();
            } catch (err) {
                currentSchedule = [];
                renderCalendar();
            }
        }

        function renderCalendar() {
            const container = document.getElementById('calendarBody');
            container.innerHTML = '';
            
            const ym = document.getElementById('yearMonthSelect').value;
            const year = parseInt(ym.substring(0, 4));
            const month = parseInt(ym.substring(4, 6)) - 1;
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDay = new Date(year, month, 1).getDay();

            // Â∞ãÊâæÂÇôË®ªÂàó
            let remarkRow = null;
            if (currentSchedule && currentSchedule.length > 0) {
                remarkRow = currentSchedule.find(row => {
                    const cellA = row[0] ? row[0].toString().trim() : '';
                    return cellA === 'ÂÇôË®ª' || cellA === 'NOTE';
                });
            }

            // Â°´ÂÖÖÁ©∫ÁôΩ
            for (let i = 0; i < firstDay; i++) {
                const div = document.createElement('div');
                div.className = "day-cell bg-slate-50/50";
                container.appendChild(div);
            }

            // Â°´ÂÖÖÊó•Êúü
            for (let d = 1; d <= daysInMonth; d++) {
                const div = document.createElement('div');
                div.className = `day-cell cursor-pointer ${selectedDates.has(d) ? 'selected' : ''}`;
                
                const num = document.createElement('div');
                num.className = "date-num";
                num.textContent = d;
                div.appendChild(num);

                // ÂÇôË®ªÁèæÂú®È°ØÁ§∫Âú®Êó•Êúü‰∏ãÊñπ (ÊúÄ‰∏äÊñπ)
                if (remarkRow) {
                    // d Â∞çÊáâÁöÑ index
                    // Ë≥áÊñôÂàóÁµêÊßã: [Name, 1Ëôü, 2Ëôü...]
                    // d=1 => index 1
                    const dataColIndex = d;
                    const remarkText = remarkRow[dataColIndex];
                    if (remarkText && remarkText.trim() !== "") {
                        const remarkDiv = document.createElement('div');
                        remarkDiv.className = "remark-tag";
                        remarkDiv.textContent = remarkText;
                        div.appendChild(remarkDiv);
                    }
                }

                const shiftsContainer = document.createElement('div');
                
                if (currentSchedule && currentSchedule.length > 0) {
                    const dataColIndex = d; 
                    currentSchedule.forEach((row, rowIndex) => {
                        if (rowIndex < 2) return; 
                        let name = row[0]; 
                        if (name) name = name.toString().trim();
                        if (!name || name === 'ÂÇôË®ª') return;
                        if (currentMode === 'view' && currentViewFilter && name !== currentViewFilter) return;

                        const shift = row[dataColIndex];
                        if (shift && shift.toString().trim() !== "") {
                            const span = document.createElement('span');
                            const colorStyle = getShiftColor(shift);
                            span.className = `shift-tag ${colorStyle.bg} ${colorStyle.text} ${colorStyle.border}`;
                            
                            // Êõ¥Êñ∞È°ØÁ§∫Ê†ºÂºè: APPLE -> üçé, ELLY -> üê±
                            let displayName = name;
                            if (name === 'APPLE') displayName = 'üçé';
                            else if (name === 'ELLY') displayName = 'üê±';
                            
                            // ÊîπÊàêÁÑ°Á©∫Ê†º
                            span.textContent = `${displayName}${shift}`;
                            shiftsContainer.appendChild(span);
                        }
                    });
                }
                div.appendChild(shiftsContainer);

                div.onclick = () => {
                    if (currentMode === 'edit') {
                        if (selectedDates.has(d)) {
                            selectedDates.delete(d);
                            div.classList.remove('selected');
                        } else {
                            selectedDates.add(d);
                            div.classList.add('selected');
                        }
                        updateSelectedCount();
                    } else {
                        let currentRemarkText = "";
                        if (remarkRow) {
                            // d=1 => index 1
                            currentRemarkText = remarkRow[d] || "";
                        }
                        openRemarkModal(d, currentRemarkText);
                    }
                };
                container.appendChild(div);
            }
        }

        function openRemarkModal(day, text) {
            editingDate = day;
            document.getElementById('remarkDateTitle').textContent = `${day}Êó•`;
            document.getElementById('remarkInput').value = text;
            document.getElementById('remarkModal').classList.add('show');
            setTimeout(() => document.getElementById('remarkInput').focus(), 100);
        }

        async function saveRemark() {
            if (editingDate === null) return;
            const text = document.getElementById('remarkInput').value;
            const ym = document.getElementById('yearMonthSelect').value;
            document.getElementById('remarkModal').classList.remove('show');
            const updates = [{ name: "ÂÇôË®ª", day: editingDate, shift: text }];
            try {
                const result = await callBackend('saveShifts', { sheetName: ym, updates: updates });
                if (result.updated > 0) {
                    showToast("ÂÇôË®ªÂ∑≤Êõ¥Êñ∞");
                    // ÂÑ≤Â≠òÊàêÂäüÔºåÁßªÈô§Âø´Âèñ‰ª•Âº∑Âà∂Âà∑Êñ∞
                    Cache.remove('month_' + ym);
                    loadMonthData();
                } else if (result.errors && result.errors.length > 0) {
                    showToast(`Êõ¥Êñ∞Â§±ÊïóÔºö${result.errors[0]}`);
                } else {
                    showToast("Êõ¥Êñ∞Â§±ÊïóÔºöÊâæ‰∏çÂà∞„ÄåÂÇôË®ª„ÄçÊ¨Ñ‰Ωç");
                }
            } catch (err) {}
        }

        function setMode(mode) {
            currentMode = mode;
            const viewBtn = document.getElementById('viewModeBtn');
            const editBtn = document.getElementById('editModeBtn');
            const editTools = document.getElementById('editTools');
            const calendarContainer = document.getElementById('calendarContainer');
            const viewFilterContainer = document.getElementById('viewFilterContainer');

            if (mode === 'edit') {
                viewBtn.className = "px-4 py-1.5 rounded-lg text-base transition-all text-slate-400 hover:text-slate-600";
                editBtn.className = "px-4 py-1.5 rounded-lg text-base transition-all bg-white shadow-sm text-sky-600 font-bold";
                editTools.classList.remove('hidden', 'translate-y-full'); // È°ØÁ§∫‰∏¶ÊªëÂÖ•
                calendarContainer.classList.replace('lg:col-span-4', 'lg:col-span-3');
                if(viewFilterContainer) viewFilterContainer.classList.add('hidden');
            } else {
                editBtn.className = "px-4 py-1.5 rounded-lg text-base transition-all text-slate-400 hover:text-slate-600";
                viewBtn.className = "px-4 py-1.5 rounded-lg text-base transition-all bg-white shadow-sm text-sky-600 font-bold";
                editTools.classList.add('translate-y-full'); // ÊªëÂá∫Èö±Ëóè
                setTimeout(() => editTools.classList.add('hidden'), 300); // ÂãïÁï´ÁµêÊùüÂæåÈö±Ëóè
                calendarContainer.classList.replace('lg:col-span-3', 'lg:col-span-4');
                if(viewFilterContainer) viewFilterContainer.classList.remove('hidden');
                clearSelection();
            }
            renderCalendar();
        }

        function updateShiftList() {
            const name = document.getElementById('personSelect').value;
            const container = document.getElementById('shiftList');
            container.innerHTML = '';
            selectedShift = null;

            if (!name || !profileData[name]) {
                container.innerHTML = '<p class="text-slate-400 text-sm whitespace-nowrap p-3">Ë´ãÂÖàÈÅ∏Êìá‰∫∫Âì°</p>';
                return;
            }

            profileData[name].forEach(shift => {
                const btn = document.createElement('button');
                const colorStyle = getShiftColor(shift);
                
                // Mobile: Pill style / Desktop: List style
                btn.className = `shrink-0 px-4 py-2 border-2 ${colorStyle.border} ${colorStyle.bg} ${colorStyle.text} rounded-xl text-sm font-bold shadow-sm transition-all whitespace-nowrap lg:w-full lg:text-left`;
                btn.textContent = shift;
                
                btn.onclick = () => {
                    // Reset styling
                    Array.from(container.children).forEach(child => {
                        if(child.tagName === 'BUTTON' && !child.textContent.includes("‰ºëÂÅá")) {
                            child.style.transform = 'scale(1)';
                            child.style.boxShadow = 'none';
                        }
                    });
                    // Active styling
                    btn.style.transform = 'scale(1.05)';
                    btn.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
                    selectedShift = shift;
                    checkSaveReady();
                };
                container.appendChild(btn);
            });
            
            // ‰ºëÂÅáÊåâÈàïÁç®Á´ãÂú®‰∏ãÊñπÔºå‰ΩÜ mobile ÁâàÊï¥ÂêàÈÄ≤ scroll list ? ‰∏çÔºåÊîæÊúÄÂæå
            // ÁÇ∫‰∫ÜÊñπ‰æøÔºåÊàëÂÄëÊääÂÆÉÂä†Âà∞ scroll list ÁöÑÊúÄÂæåÈù¢
            const clearBtn = document.createElement('button');
            clearBtn.className = "shrink-0 px-4 py-2 border-2 border-dashed border-red-300 bg-red-50 text-red-500 rounded-xl text-sm font-bold whitespace-nowrap lg:w-full lg:col-span-2 lg:mt-2";
            clearBtn.textContent = "Ê∏ÖÈô§";
            clearBtn.onclick = () => {
                 selectedShift = ""; 
                 checkSaveReady();
                 // Visual feedback
                 Array.from(container.children).forEach(child => child.style.transform = 'scale(1)');
                 clearBtn.style.transform = 'scale(1.05)';
            };
            container.appendChild(clearBtn);
        }

        function updateSelectedCount() {
            const count = selectedDates.size;
            document.getElementById('selectedCountDesktop').textContent = count;
            document.getElementById('selectedCountMobile').textContent = count;
            checkSaveReady();
        }

        function checkSaveReady() {
            const btn = document.getElementById('saveBtn');
            const btnText = document.getElementById('saveBtnText');
            const person = document.getElementById('personSelect').value;
            const isReady = selectedDates.size > 0 && person && selectedShift !== null;
            
            btn.disabled = !isReady;

            if (isReady) {
                if (selectedShift === "") {
                    btnText.textContent = `Âà™Èô§ÊéíÁè≠`;
                    btn.className = "flex-1 bg-red-400 text-white py-3 rounded-xl text-lg font-bold hover:bg-red-500 shadow-lg shadow-red-200 transition-all transform active:scale-95 flex justify-center items-center gap-2";
                } else {
                    btnText.textContent = `ÂÑ≤Â≠ò: ${selectedShift}`;
                    btn.className = "flex-1 bg-sky-400 text-white py-3 rounded-xl text-lg font-bold hover:bg-sky-500 shadow-lg shadow-sky-200 transition-all transform active:scale-95 flex justify-center items-center gap-2";
                }
            } else {
                btnText.textContent = "Ë´ãÈÅ∏Êó•Êúü";
                btn.className = "flex-1 bg-slate-200 text-slate-400 py-3 rounded-xl text-lg font-bold disabled:shadow-none cursor-not-allowed flex justify-center items-center gap-2";
            }
        }

        function clearSelection() {
            selectedDates.clear();
            updateSelectedCount();
            renderCalendar();
        }

        async function applyBatchShifts() {
            const person = document.getElementById('personSelect').value;
            const ym = document.getElementById('yearMonthSelect').value;
            if (!person || !selectedDates.size || selectedShift === null) return;
            const updates = [];
            selectedDates.forEach(day => {
                updates.push({ name: person, day: day, shift: selectedShift });
            });
            try {
                const result = await callBackend('saveShifts', { sheetName: ym, updates: updates });
                if (result.updated > 0) {
                    showToast(`ÊàêÂäüÊõ¥Êñ∞ ${result.updated} Á≠Ü`);
                } else if (result.errors.length > 0) {
                     showToast(`Â§±ÊïóÔºö${result.errors[0]}`);
                } else {
                    showToast("Êú™Êõ¥Êñ∞ÔºåË´ãÊ™¢Êü•‰∫∫Âì°ÂêçÁ®±");
                }
                // ÂÑ≤Â≠òÊàêÂäüÂæåÊ∏ÖÈô§Âø´ÂèñÔºåÁ¢∫‰øù‰∏ãÊ¨°ËÆÄÂèñÊúÄÊñ∞
                Cache.remove('month_' + ym);
                clearSelection();
                loadMonthData(); 
            } catch (err) {}
        }

        function clearCacheAndReload() {
            Cache.clearAll();
            showToast("Âø´ÂèñÂ∑≤Ê∏ÖÈô§ÔºåÊ≠£Âú®ÈáçÊñ∞ËºâÂÖ•...");
            // ÈáçÊñ∞ËºâÂÖ• Profile Âíå Month Data
            initApp();
        }

        function showDebugModal() {
            document.getElementById('debugModal').classList.add('show');
            const content = document.getElementById('debugContent');
            const ym = document.getElementById('yearMonthSelect').value;
            let report = `=== Ë≥áÊñôÊ™¢Êü•Â†±Âëä ===\n`;
            report += `Êúà‰ªΩ: ${ym}\n`;
            
            // Ê™¢Êü•ÊòØÂê¶ÂæûÂø´ÂèñËÆÄÂèñ
            const cached = Cache.get('month_' + ym);
            report += `Ë≥áÊñô‰æÜÊ∫ê: ${cached ? 'Âø´Âèñ (Local Cache)' : '‰º∫ÊúçÂô® (Server)'}\n`;

            if (!currentSchedule || currentSchedule.length === 0) {
                report += `[Ë≠¶Âëä] ÂâçÁ´ØÊú™Êî∂Âà∞Ë≥áÊñô„ÄÇ\n`;
            } else {
                report += `Ë≥áÊñôÂàóÊï∏: ${currentSchedule.length}\n`;
                const remarkRow = currentSchedule.find(r => r[0] == 'ÂÇôË®ª');
                report += remarkRow ? `[O] ÂÇôË®ªÂàóÊ≠£Â∏∏\n` : `[X] Êâæ‰∏çÂà∞ÂÇôË®ªÂàó (AÊ¨Ñ)\n`;
                report += `-------------------\n[‰∫∫Âì°È†êË¶Ω]:\n`;
                currentSchedule.slice(0, 10).forEach((row, idx) => {
                    if(idx < 2) return;
                    let name = row[0];
                    if(name) {
                        name = name.toString().trim();
                        if(name !== 'ÂÇôË®ª') {
                             const val = row[1];
                             report += `${name}: 1Ëôü="${val || '_'}"\n`;
                        }
                    }
                });
            }
            content.textContent = report;
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMsg').textContent = msg;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        function toggleLoader(show) {
            document.getElementById('globalLoader').classList.toggle('hidden', !show);
        }
    </script>
</body>
</html>
