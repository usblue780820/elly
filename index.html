<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 APPLE & ELLY 班表</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 引入使用者上傳的手寫字型 */
        @font-face {
            font-family: 'JasonHandwriting';
            src: url('JasonHandwriting1.ttf') format('truetype');
            font-display: swap;
        }

        :root {
            --primary-color: #38bdf8; /* Sky 400 */
            --primary-dark: #0ea5e9; /* Sky 500 */
            --bg-color: #f0f9ff; /* Sky 50 */
        }

        body {
            font-family: 'JasonHandwriting', '微軟正黑體', sans-serif;
            background-color: var(--bg-color);
            color: #334155; /* Slate 700 */
            -webkit-tap-highlight-color: transparent; /* 移除手機點擊高亮 */
            position: relative; /* 為背景定位做準備 */
        }

        /* 讓字體稍微大一點以利閱讀手寫字 */
        button, select, input, textarea {
            font-family: 'JasonHandwriting', sans-serif;
            font-size: 1.1rem; 
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: #e0f2fe; /* 格線顏色 */
            border-radius: 0 0 1rem 1rem;
            overflow: hidden;
        }

        .day-cell {
            min-height: 85px; /* 手機上高度縮小 */
            background-color: white;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            padding: 2px; /* 手機上內距縮小 */
            position: relative;
        }

        @media (min-width: 768px) {
            .day-cell {
                min-height: 130px; /* 電腦上高度 */
                padding: 8px;
            }
        }

        .day-cell:active {
            background-color: #f0f9ff;
        }

        .day-cell.selected {
            background-color: #e0f2fe !important;
            box-shadow: inset 0 0 0 2px #38bdf8;
        }

        .date-num {
            font-size: 1rem; /* 手機上字體縮小 */
            color: #94a3b8;
            margin-bottom: 2px;
            font-weight: bold;
            padding-left: 2px;
        }
        
        @media (min-width: 768px) {
            .date-num {
                font-size: 1.2rem;
                margin-bottom: 4px;
            }
        }

        /* 班別標籤基本樣式 */
        .shift-tag {
            font-size: 0.8rem; /* 手機上班表字體縮小 */
            padding: 2px 4px;
            border-radius: 6px;
            margin-top: 2px;
            display: block;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            font-weight: bold;
            border-left-width: 3px;
            line-height: 1.2;
        }

        @media (min-width: 768px) {
            .shift-tag {
                font-size: 0.9rem;
                padding: 4px 6px;
                margin-top: 3px;
                border-left-width: 4px;
            }
        }

        .remark-tag {
            font-size: 0.75rem;
            padding: 4px;
            margin-top: auto;
            margin-bottom: 1px;
            background-color: #fffbeb; /* Amber 50 */
            border: 1px dashed #fcd34d; /* Amber 300 */
            color: #92400e;
            border-radius: 6px;
            white-space: pre-wrap;
            word-break: break-all;
            line-height: 1.2;
        }

        /* 背景裝飾圖片樣式 */
        .bg-decor-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* 讓點擊穿透 */
            z-index: -1; /* 放在最底層，月曆下面 */
            overflow: hidden;
        }

        .decor-img {
            position: absolute;
            opacity: 0.05; /* 透明度 95% (保留 5% 不透明度) */
            width: 260px; /* 放大 30% (200 * 1.3) */
            max-width: 52vw; /* 手機版不超過螢幕寬度 52% */
        }

        .decor-top-right {
            top: 20px;
            right: -20px;
            transform: rotate(15deg);
        }

        .decor-mid-left {
            top: 50%;
            left: -30px;
            transform: translateY(-50%) rotate(-10deg);
        }

        .decor-btm-right {
            bottom: 20px;
            right: -20px;
            transform: rotate(-15deg);
        }

        /* 載入動畫 */
        .loader {
            border: 4px solid #e0f2fe;
            border-top: 4px solid #38bdf8;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .modal { 
            display: none; 
            opacity: 0;
            transition: opacity 0.3s;
        }
        .modal.show { 
            display: flex; 
            opacity: 1;
        }

        /* 自定義捲軸 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }

        /* 浮動按鈕陰影 */
        .shadow-soft {
            box-shadow: 0 4px 20px -2px rgba(56, 189, 248, 0.25);
        }
    </style>
</head>
<body class="pb-24 lg:pb-10 relative">

    <!-- 背景裝飾層 (固定在視窗，位於所有內容之下) -->
    <div class="bg-decor-container">
        <img src="kiki.jpg" class="decor-img decor-top-right" alt="" onerror="this.style.display='none'">
        <img src="kiki.jpg" class="decor-img decor-mid-left" alt="" onerror="this.style.display='none'">
        <img src="kiki.jpg" class="decor-img decor-btm-right" alt="" onerror="this.style.display='none'">
    </div>

    <div id="app" class="max-w-6xl mx-auto p-2 lg:p-6 relative z-10">
        
        <!-- 頂部卡片 (手機版優化：縮小 Padding，調整佈局) -->
        <div class="bg-white rounded-2xl lg:rounded-3xl shadow-soft p-3 lg:p-4 mb-4 border border-sky-100">
            <div class="flex flex-col gap-3">
                
                <!-- 標題與切換 -->
                <div class="flex flex-col sm:flex-row items-center justify-between gap-3">
                    <h1 class="text-xl lg:text-3xl text-sky-500 font-bold tracking-wide truncate w-full text-center sm:text-left">2026 APPLE & ELLY 班表</h1>
                    
                    <div class="flex bg-sky-50 p-1 rounded-xl shrink-0 w-full sm:w-auto">
                        <button id="viewModeBtn" onclick="setMode('view')" class="flex-1 sm:flex-none px-4 py-1.5 rounded-lg text-base lg:text-lg transition-all duration-300 bg-white shadow-sm text-sky-600 font-bold">瀏覽</button>
                        <button id="editModeBtn" onclick="setMode('edit')" class="flex-1 sm:flex-none px-4 py-1.5 rounded-lg text-base lg:text-lg transition-all duration-300 text-slate-400 hover:text-slate-600">排班</button>
                    </div>
                </div>

                <!-- 控制項 (手機版：自動換行，按鈕變大) -->
                <div class="flex flex-wrap items-center gap-2 w-full justify-between sm:justify-end">
                    
                    <!-- 瀏覽模式篩選器 (僅在瀏覽模式顯示) -->
                    <div id="viewFilterContainer" class="flex-1 min-w-[120px] sm:flex-none transition-all duration-300">
                        <select id="viewFilterSelect" onchange="applyViewFilter()" class="w-full bg-sky-50 border-2 border-sky-100 text-sky-600 rounded-xl px-2 py-2 text-base lg:text-lg focus:outline-none focus:border-sky-300 transition-colors cursor-pointer text-center sm:text-left">
                            <option value="">顯示全部</option>
                        </select>
                    </div>

                    <div class="flex-1 min-w-[130px] sm:flex-none">
                        <select id="yearMonthSelect" onchange="loadMonthData()" class="w-full bg-white border-2 border-sky-100 text-slate-600 rounded-xl px-2 py-2 text-base lg:text-lg focus:outline-none focus:border-sky-300 transition-colors cursor-pointer text-center sm:text-left">
                            <option value="202601">2026 01月</option>
                            <option value="202602">2026 02月</option>
                            <option value="202603">2026 03月</option>
                            <option value="202604">2026 04月</option>
                            <option value="202605">2026 05月</option>
                            <option value="202606">2026 06月</option>
                            <option value="202607">2026 07月</option>
                            <option value="202608">2026 08月</option>
                            <option value="202609">2026 09月</option>
                            <option value="202610">2026 10月</option>
                            <option value="202611">2026 11月</option>
                            <option value="202612">2026 12月</option>
                        </select>
                    </div>
                    
                    <div class="flex gap-2">
                        <div id="connectionStatus" class="flex items-center justify-center w-10 h-10 bg-slate-100 rounded-xl text-slate-400 shrink-0" title="連線狀態">
                            <span class="w-3 h-3 rounded-full bg-slate-300"></span>
                        </div>

                        <button onclick="showDebugModal()" class="w-10 h-10 flex items-center justify-center text-slate-400 hover:text-sky-500 hover:bg-sky-50 bg-white border border-slate-100 rounded-xl transition-colors shrink-0" title="檢查資料">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 lg:gap-6">
            
            <!-- 左側排班工具 (卡片式) -->
            <div id="editTools" class="lg:col-span-1 hidden order-first lg:order-first">
                <div class="bg-white p-4 lg:p-5 rounded-2xl lg:rounded-3xl shadow-soft sticky top-2 border border-sky-100">
                    <div class="flex items-center gap-2 mb-3 pb-3 border-b border-sky-50">
                        <div class="w-8 h-8 rounded-full bg-sky-100 flex items-center justify-center text-sky-500">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                            </svg>
                        </div>
                        <h2 class="text-lg lg:text-xl font-bold text-slate-700">快速排班</h2>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-bold text-sky-400 mb-1 pl-1">1. 選擇人員</label>
                            <div class="relative">
                                <select id="personSelect" onchange="updateShiftList()" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-2.5 appearance-none focus:ring-2 focus:ring-sky-200 focus:border-sky-400 outline-none transition-all text-base">
                                    <option value="">請選擇人員...</option>
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-slate-400">
                                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-sky-400 mb-1 pl-1">2. 選擇班別</label>
                            <div id="shiftList" class="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-2 gap-2 max-h-48 lg:max-h-64 overflow-y-auto pr-1">
                                <p class="text-slate-300 text-base text-center col-span-3 lg:col-span-2 py-4">請先選擇人員</p>
                            </div>
                        </div>

                        <div class="pt-3 border-t border-sky-50">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-slate-400">已選日期</span>
                                <span id="selectedCount" class="text-xl font-bold text-sky-500">0</span>
                            </div>
                            <button onclick="applyBatchShifts()" id="saveBtn" disabled class="w-full bg-sky-400 text-white py-2.5 rounded-xl text-lg font-bold hover:bg-sky-500 shadow-lg shadow-sky-200 disabled:bg-slate-200 disabled:text-slate-400 disabled:shadow-none transition-all transform active:scale-95">
                                儲存排班
                            </button>
                            <button onclick="clearSelection()" class="w-full mt-2 text-slate-400 py-2 text-sm hover:text-sky-500 transition-colors">清除選取</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 主日曆區域 -->
            <div id="calendarContainer" class="lg:col-span-4 bg-white rounded-2xl lg:rounded-3xl shadow-soft border border-sky-100 overflow-hidden relative">
                <!-- 星期標題 -->
                <div class="calendar-grid !bg-sky-50 !gap-0 rounded-t-2xl lg:rounded-t-3xl border-b border-sky-100 relative z-20">
                    <div class="py-2 lg:py-4 text-center text-sm lg:text-lg font-bold text-sky-600">週日</div>
                    <div class="py-2 lg:py-4 text-center text-sm lg:text-lg font-bold text-sky-600">週一</div>
                    <div class="py-2 lg:py-4 text-center text-sm lg:text-lg font-bold text-sky-600">週二</div>
                    <div class="py-2 lg:py-4 text-center text-sm lg:text-lg font-bold text-sky-600">週三</div>
                    <div class="py-2 lg:py-4 text-center text-sm lg:text-lg font-bold text-sky-600">週四</div>
                    <div class="py-2 lg:py-4 text-center text-sm lg:text-lg font-bold text-sky-600">週五</div>
                    <div class="py-2 lg:py-4 text-center text-sm lg:text-lg font-bold text-sky-600">週六</div>
                </div>
                
                <div class="relative">
                    <div id="calendarBody" class="calendar-grid relative z-10 bg-transparent">
                        <div class="col-span-7 py-20 flex flex-col items-center justify-center text-slate-300 gap-4">
                            <div class="loader"></div>
                            <span class="text-xl">讀取資料中...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 彈窗區域 (模態框) -->
        
        <!-- 備註編輯 -->
        <div id="remarkModal" class="modal fixed inset-0 bg-sky-900/30 backdrop-blur-sm z-50 items-center justify-center p-4">
            <div class="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-sm transform transition-all scale-100">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold text-slate-700">編輯備註</h3>
                    <span id="remarkDateTitle" class="bg-sky-100 text-sky-600 px-3 py-1 rounded-full text-sm font-bold"></span>
                </div>
                <div class="mb-6">
                    <textarea id="remarkInput" rows="5" class="w-full bg-amber-50 border-2 border-amber-100 rounded-2xl p-4 text-lg text-slate-700 focus:ring-4 focus:ring-amber-100 focus:border-amber-300 outline-none resize-none placeholder-amber-200" placeholder="寫點什麼..."></textarea>
                </div>
                <div class="flex gap-3">
                    <button onclick="document.getElementById('remarkModal').classList.remove('show')" class="flex-1 py-3 text-lg text-slate-500 hover:bg-slate-50 rounded-2xl transition-colors">取消</button>
                    <button onclick="saveRemark()" class="flex-1 py-3 text-lg bg-sky-400 text-white rounded-2xl font-bold hover:bg-sky-500 shadow-lg shadow-sky-200 transition-all active:scale-95">儲存</button>
                </div>
            </div>
        </div>

        <!-- Debug -->
        <div id="debugModal" class="modal fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 items-center justify-center p-4">
            <div class="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-2xl max-h-[80vh] flex flex-col">
                <h3 class="text-2xl font-bold mb-4 text-slate-700 flex items-center gap-2">
                    <svg class="w-6 h-6 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" /></svg>
                    資料診斷
                </h3>
                <div class="flex-1 overflow-auto border-2 border-slate-100 rounded-2xl p-4 bg-slate-50 font-mono text-sm text-slate-600">
                    <pre id="debugContent">正在讀取...</pre>
                </div>
                <div class="pt-4 text-right">
                    <button onclick="document.getElementById('debugModal').classList.remove('show')" class="px-6 py-2 bg-slate-200 text-slate-600 rounded-xl hover:bg-slate-300 font-bold">關閉</button>
                </div>
            </div>
        </div>

        <!-- Toast -->
        <div id="toast" class="fixed bottom-8 left-1/2 transform -translate-x-1/2 translate-y-20 opacity-0 transition-all duration-300 bg-slate-800/90 backdrop-blur text-white px-6 py-3 rounded-2xl shadow-2xl flex items-center gap-3 z-[60]">
            <span id="toastMsg" class="font-bold tracking-wide"></span>
        </div>

        <!-- Full Loader -->
        <div id="globalLoader" class="fixed inset-0 bg-white/80 backdrop-blur-sm z-[70] flex flex-col items-center justify-center hidden">
            <div class="loader mb-4 w-16 h-16 border-4"></div>
            <p class="text-sky-500 font-bold text-xl animate-pulse">資料同步中...</p>
        </div>
    </div>

    <!-- 邏輯腳本 -->
    <script>
        const DEFAULT_URL = 'https://script.google.com/macros/s/AKfycbzCBZ2i6P68KZ_LjgoVhQjcD2dMLcw1nd5pjMcxX_me-Sl1CWGnrrVYLe-AmMRbnvYY/exec';
        
        // --- 顏色定義與邏輯 ---
        const shiftColorStyles = [
            { bg: 'bg-orange-50', text: 'text-orange-700', border: 'border-orange-300' },
            { bg: 'bg-emerald-50', text: 'text-emerald-700', border: 'border-emerald-300' },
            { bg: 'bg-violet-50', text: 'text-violet-700', border: 'border-violet-300' },
            { bg: 'bg-rose-50', text: 'text-rose-700', border: 'border-rose-300' },
            { bg: 'bg-amber-50', text: 'text-amber-700', border: 'border-amber-300' },
            { bg: 'bg-fuchsia-50', text: 'text-fuchsia-700', border: 'border-fuchsia-300' },
            { bg: 'bg-indigo-50', text: 'text-indigo-700', border: 'border-indigo-300' },
            { bg: 'bg-lime-50', text: 'text-lime-700', border: 'border-lime-300' },
            { bg: 'bg-pink-50', text: 'text-pink-700', border: 'border-pink-300' },
            { bg: 'bg-teal-50', text: 'text-teal-700', border: 'border-teal-300' },
        ];

        function getShiftColor(name) {
            if (!name) return shiftColorStyles[0];
            
            // 特別處理 "休假"
            if (name.includes("休假")) {
                return { bg: 'bg-red-50', text: 'text-red-700', border: 'border-red-300' };
            }

            let hash = 0;
            for (let i = 0; i < name.length; i++) {
                hash = name.charCodeAt(i) + ((hash << 5) - hash);
            }
            const index = Math.abs(hash) % shiftColorStyles.length;
            return shiftColorStyles[index];
        }
        // -------------------

        let scriptUrl = localStorage.getItem('gas_script_url');
        if (!scriptUrl) {
            scriptUrl = DEFAULT_URL;
        }

        let currentMode = 'view';
        let profileData = {}; 
        let currentSchedule = []; 
        let selectedDates = new Set();
        let selectedShift = null;
        let editingDate = null;
        let currentViewFilter = ""; // 瀏覽模式篩選器狀態

        window.onload = function() {
            checkConfig();
            
            // 自動跳轉至當月份
            const now = new Date();
            const currentYm = now.getFullYear() + String(now.getMonth() + 1).padStart(2, '0');
            const ymSelect = document.getElementById('yearMonthSelect');
            
            // 檢查選單中是否有該月份，若有則自動選取
            if (ymSelect.querySelector(`option[value="${currentYm}"]`)) {
                ymSelect.value = currentYm;
            }

            if (scriptUrl) {
                initApp();
            }
        };

        function checkConfig() {
            const status = document.getElementById('connectionStatus');
            if (!scriptUrl) {
                status.innerHTML = '<span class="w-3 h-3 rounded-full bg-red-400 shadow-sm"></span>';
                status.title = "未連線";
            } else {
                status.innerHTML = '<span class="w-3 h-3 rounded-full bg-green-400 shadow-[0_0_8px_rgba(74,222,128,0.6)]"></span>';
                status.title = "已連線";
            }
        }

        async function callBackend(action, payload = {}) {
            if (!scriptUrl) return;
            toggleLoader(true);
            const body = JSON.stringify({ action, ...payload });
            try {
                const response = await fetch(scriptUrl, {
                    method: 'POST',
                    mode: 'cors',
                    body: body
                });
                const text = await response.text();
                let json;
                try {
                    json = JSON.parse(text);
                } catch (e) {
                    throw new Error("後端回傳格式錯誤");
                }
                if (json.status === 'error') {
                    throw new Error(json.message);
                }
                return json.data;
            } catch (err) {
                console.error('API Error:', err);
                showToast("連線錯誤: " + err.message);
                throw err;
            } finally {
                toggleLoader(false);
            }
        }

        async function initApp() {
            try {
                profileData = await callBackend('getProfile');
                renderPersonSelect();
                renderViewFilterSelect(); // 渲染篩選選單
                loadMonthData();
            } catch (err) {
                console.error("Init failed", err);
            }
        }

        function renderPersonSelect() {
            const select = document.getElementById('personSelect');
            select.innerHTML = '<option value="">請選擇人員...</option>';
            if (!profileData || Object.keys(profileData).length === 0) {
                 select.innerHTML = '<option value="">無人員資料</option>';
                 return;
            }
            Object.keys(profileData).forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                opt.textContent = name;
                select.appendChild(opt);
            });
        }

        function renderViewFilterSelect() {
            const select = document.getElementById('viewFilterSelect');
            select.innerHTML = '<option value="">顯示全部</option>';
            if (profileData && Object.keys(profileData).length > 0) {
                Object.keys(profileData).forEach(name => {
                    const opt = document.createElement('option');
                    opt.value = name;
                    opt.textContent = name;
                    select.appendChild(opt);
                });
            }
        }

        function applyViewFilter() {
            currentViewFilter = document.getElementById('viewFilterSelect').value;
            renderCalendar(); // 重新渲染日曆以應用篩選
        }

        async function loadMonthData() {
            const ym = document.getElementById('yearMonthSelect').value;
            try {
                const result = await callBackend('getMonthData', { sheetName: ym });
                if (!result.exists) {
                    showToast(`無 ${ym} 資料`);
                    currentSchedule = [];
                } else {
                    currentSchedule = result.values;
                }
                renderCalendar();
            } catch (err) {
                currentSchedule = [];
                renderCalendar();
            }
        }

        function renderCalendar() {
            const container = document.getElementById('calendarBody');
            container.innerHTML = '';
            
            const ym = document.getElementById('yearMonthSelect').value;
            const year = parseInt(ym.substring(0, 4));
            const month = parseInt(ym.substring(4, 6)) - 1;
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDay = new Date(year, month, 1).getDay();

            // 尋找備註列
            let remarkRow = null;
            if (currentSchedule && currentSchedule.length > 0) {
                remarkRow = currentSchedule.find(row => {
                    const cellA = row[0] ? row[0].toString().trim() : '';
                    return cellA === '備註' || cellA === 'NOTE';
                });
            }

            // 填充空白
            for (let i = 0; i < firstDay; i++) {
                const div = document.createElement('div');
                div.className = "day-cell bg-slate-50/50";
                container.appendChild(div);
            }

            // 填充日期
            for (let d = 1; d <= daysInMonth; d++) {
                const div = document.createElement('div');
                div.className = `day-cell cursor-pointer ${selectedDates.has(d) ? 'selected' : ''}`;
                
                const num = document.createElement('div');
                num.className = "date-num";
                num.textContent = d;
                div.appendChild(num);

                const shiftsContainer = document.createElement('div');
                
                if (currentSchedule && currentSchedule.length > 0) {
                    const dataColIndex = d; 

                    currentSchedule.forEach((row, rowIndex) => {
                        if (rowIndex < 2) return; 

                        let name = row[0]; 
                        if (name) name = name.toString().trim();
                        if (!name || name === '備註') return;

                        // 瀏覽模式篩選邏輯
                        if (currentMode === 'view' && currentViewFilter && name !== currentViewFilter) {
                            return;
                        }

                        const shift = row[dataColIndex];
                        if (shift && shift.toString().trim() !== "") {
                            const span = document.createElement('span');
                            
                            // 套用動態顏色
                            const colorStyle = getShiftColor(shift);
                            span.className = `shift-tag ${colorStyle.bg} ${colorStyle.text} ${colorStyle.border}`;
                            
                            span.textContent = `${name} ${shift}`;
                            shiftsContainer.appendChild(span);
                        }
                    });

                    if (remarkRow) {
                        const remarkText = remarkRow[dataColIndex];
                        if (remarkText && remarkText.trim() !== "") {
                            const remarkDiv = document.createElement('div');
                            remarkDiv.className = "remark-tag";
                            remarkDiv.textContent = remarkText;
                            div.appendChild(remarkDiv);
                        }
                    }
                }
                div.appendChild(shiftsContainer);

                div.onclick = () => {
                    if (currentMode === 'edit') {
                        if (selectedDates.has(d)) {
                            selectedDates.delete(d);
                            div.classList.remove('selected');
                        } else {
                            selectedDates.add(d);
                            div.classList.add('selected');
                        }
                        updateSelectedCount();
                    } else {
                        // 瀏覽模式點擊編輯備註
                        let currentRemarkText = "";
                        if (remarkRow) {
                            currentRemarkText = remarkRow[d] || "";
                        }
                        openRemarkModal(d, currentRemarkText);
                    }
                };
                container.appendChild(div);
            }
        }

        function openRemarkModal(day, text) {
            editingDate = day;
            document.getElementById('remarkDateTitle').textContent = `${day}日`;
            document.getElementById('remarkInput').value = text;
            document.getElementById('remarkModal').classList.add('show');
            setTimeout(() => document.getElementById('remarkInput').focus(), 100);
        }

        async function saveRemark() {
            if (editingDate === null) return;
            const text = document.getElementById('remarkInput').value;
            const ym = document.getElementById('yearMonthSelect').value;
            document.getElementById('remarkModal').classList.remove('show');

            const updates = [{
                name: "備註",
                day: editingDate,
                shift: text
            }];

            try {
                const result = await callBackend('saveShifts', {
                    sheetName: ym,
                    updates: updates
                });
                if (result.updated > 0) {
                    showToast("備註已更新");
                    loadMonthData();
                } else if (result.errors && result.errors.length > 0) {
                    showToast(`更新失敗：${result.errors[0]}`);
                } else {
                    showToast("更新失敗：找不到「備註」欄位");
                }
            } catch (err) {}
        }

        function setMode(mode) {
            currentMode = mode;
            const viewBtn = document.getElementById('viewModeBtn');
            const editBtn = document.getElementById('editModeBtn');
            const editTools = document.getElementById('editTools');
            const calendarContainer = document.getElementById('calendarContainer');
            const viewFilterContainer = document.getElementById('viewFilterContainer');

            if (mode === 'edit') {
                viewBtn.className = "px-5 py-2 rounded-xl text-lg transition-all duration-300 text-slate-400 hover:text-slate-600";
                editBtn.className = "px-5 py-2 rounded-xl text-lg transition-all duration-300 bg-white shadow-sm text-sky-600 font-bold";
                editTools.classList.remove('hidden');
                calendarContainer.classList.replace('lg:col-span-4', 'lg:col-span-3');
                
                // 隱藏瀏覽篩選器
                if(viewFilterContainer) viewFilterContainer.classList.add('hidden');
            } else {
                editBtn.className = "px-5 py-2 rounded-xl text-lg transition-all duration-300 text-slate-400 hover:text-slate-600";
                viewBtn.className = "px-5 py-2 rounded-xl text-lg transition-all duration-300 bg-white shadow-sm text-sky-600 font-bold";
                editTools.classList.add('hidden');
                calendarContainer.classList.replace('lg:col-span-3', 'lg:col-span-4');
                
                // 顯示瀏覽篩選器
                if(viewFilterContainer) viewFilterContainer.classList.remove('hidden');
                
                clearSelection();
            }
            renderCalendar();
        }

        function updateShiftList() {
            const name = document.getElementById('personSelect').value;
            const container = document.getElementById('shiftList');
            container.innerHTML = '';
            selectedShift = null;

            if (!name || !profileData[name]) {
                container.innerHTML = '<p class="text-slate-300 text-base text-center col-span-3 lg:col-span-2 py-4">請先選擇人員</p>';
                return;
            }

            profileData[name].forEach(shift => {
                const btn = document.createElement('button');
                // 取得顏色
                const colorStyle = getShiftColor(shift);
                // 預設樣式：左側帶有顏色邊框
                const baseClass = `w-full px-2 py-2.5 border-l-4 ${colorStyle.border.replace('border', 'border-l')} bg-white border border-slate-100 rounded-r-xl text-sm text-slate-600 hover:bg-slate-50 transition-all font-bold text-left`;
                
                btn.className = baseClass;
                btn.textContent = shift;
                
                btn.onclick = () => {
                    // 重置其他按鈕
                    document.querySelectorAll('#shiftList button').forEach(b => {
                        // 恢復原始 class，但不包括休假/清除按鈕 (現在只有清除按鈕是特殊的)
                        if (!b.textContent.includes("清除排班")) {
                            // 重新計算該按鈕的顏色
                            const s = b.textContent;
                            const c = getShiftColor(s);
                            b.className = `w-full px-2 py-2.5 border-l-4 ${c.border.replace('border', 'border-l')} bg-white border border-slate-100 rounded-r-xl text-sm text-slate-600 hover:bg-slate-50 transition-all font-bold text-left`;
                        } else {
                            // 清除按鈕重置
                            b.className = "w-full col-span-3 lg:col-span-2 px-2 py-2.5 border-2 border-dashed border-red-200 text-red-400 rounded-xl text-sm hover:bg-red-50 hover:border-red-300 transition-all mt-1 font-bold";
                        }
                    });
                    
                    // 設定選中樣式
                    btn.className = `w-full px-2 py-2.5 ${colorStyle.bg} border-2 ${colorStyle.border} ${colorStyle.text} rounded-xl text-sm transition-all font-bold shadow-md text-left`;
                    
                    selectedShift = shift;
                    checkSaveReady();
                };
                container.appendChild(btn);
            });
            
            const clearBtn = document.createElement('button');
            clearBtn.className = "w-full col-span-3 lg:col-span-2 px-2 py-2.5 border-2 border-dashed border-red-200 text-red-400 rounded-xl text-sm hover:bg-red-50 hover:border-red-300 transition-all mt-1 font-bold";
            clearBtn.textContent = "清除排班 (Delete)";
            clearBtn.onclick = () => {
                document.querySelectorAll('#shiftList button').forEach(b => {
                    if (!b.textContent.includes("清除排班")) {
                        const s = b.textContent;
                        const c = getShiftColor(s);
                        b.className = `w-full px-2 py-2.5 border-l-4 ${c.border.replace('border', 'border-l')} bg-white border border-slate-100 rounded-r-xl text-sm text-slate-600 hover:bg-slate-50 transition-all font-bold text-left`;
                    }
                });
                clearBtn.className = "w-full col-span-3 lg:col-span-2 px-2 py-2.5 border-2 border-red-500 bg-red-500 text-white rounded-xl text-sm transition-all mt-1 font-bold shadow-md";
                selectedShift = ""; 
                checkSaveReady();
            };
            container.appendChild(clearBtn);
        }

        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = selectedDates.size;
            checkSaveReady();
        }

        function checkSaveReady() {
            const btn = document.getElementById('saveBtn');
            const person = document.getElementById('personSelect').value;
            // selectedShift is null when nothing selected. "" when clear is selected.
            const isReady = selectedDates.size > 0 && person && selectedShift !== null;
            
            btn.disabled = !isReady;

            if (isReady) {
                if (selectedShift === "") {
                    btn.textContent = `刪除 ${person} 的排班`; // Explicitly mention user
                    btn.className = "w-full bg-red-400 text-white py-2.5 rounded-xl text-lg font-bold hover:bg-red-500 shadow-lg shadow-red-200 transition-all transform active:scale-95";
                } else {
                    btn.textContent = "儲存排班";
                    btn.className = "w-full bg-sky-400 text-white py-2.5 rounded-xl text-lg font-bold hover:bg-sky-500 shadow-lg shadow-sky-200 transition-all transform active:scale-95";
                }
            } else {
                btn.textContent = "儲存排班";
                btn.className = "w-full bg-sky-400 text-white py-2.5 rounded-xl text-lg font-bold hover:bg-sky-500 shadow-lg shadow-sky-200 disabled:bg-slate-200 disabled:text-slate-400 disabled:shadow-none transition-all transform active:scale-95";
            }
        }

        function clearSelection() {
            selectedDates.clear();
            updateSelectedCount();
            renderCalendar();
        }

        async function applyBatchShifts() {
            const person = document.getElementById('personSelect').value;
            const ym = document.getElementById('yearMonthSelect').value;
            
            if (!person || !selectedDates.size || selectedShift === null) return;
            const updates = [];
            selectedDates.forEach(day => {
                updates.push({ name: person, day: day, shift: selectedShift });
            });
            try {
                const result = await callBackend('saveShifts', { sheetName: ym, updates: updates });
                if (result.updated > 0) {
                    showToast(`成功更新 ${result.updated} 筆`);
                } else if (result.errors.length > 0) {
                     showToast(`失敗：${result.errors[0]}`);
                } else {
                    showToast("未更新，請檢查人員名稱");
                }
                clearSelection();
                loadMonthData(); 
            } catch (err) {}
        }

        function showDebugModal() {
            document.getElementById('debugModal').classList.add('show');
            const content = document.getElementById('debugContent');
            const ym = document.getElementById('yearMonthSelect').value;
            let report = `=== 資料檢查報告 ===\n`;
            report += `月份: ${ym}\n`;
            if (!currentSchedule || currentSchedule.length === 0) {
                report += `[警告] 前端未收到資料。\n`;
            } else {
                report += `資料列數: ${currentSchedule.length}\n`;
                const remarkRow = currentSchedule.find(r => r[0] == '備註');
                report += remarkRow ? `[O] 備註列正常\n` : `[X] 找不到備註列 (A欄)\n`;
                report += `-------------------\n[人員預覽]:\n`;
                currentSchedule.slice(0, 10).forEach((row, idx) => {
                    if(idx < 2) return;
                    let name = row[0];
                    if(name) {
                        name = name.toString().trim();
                        if(name !== '備註') {
                             const val = row[1];
                             report += `${name}: 1號="${val || '_'}"\n`;
                        }
                    }
                });
            }
            content.textContent = report;
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMsg').textContent = msg;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        function toggleLoader(show) {
            document.getElementById('globalLoader').classList.toggle('hidden', !show);
        }
    </script>
</body>
</html>
